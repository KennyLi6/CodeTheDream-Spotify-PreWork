(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();const f="1e8524a3ff89495495111505875160d2",k=(window.location.origin+window.location.pathname).replace(/index\.html$/,""),C=["user-read-playback-state","user-read-currently-playing","user-modify-playback-state","playlist-read-private","user-read-private"].join(" "),y="spotify_auth";function w(e=64){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=new Uint8Array(e);crypto.getRandomValues(t);let r="";for(let o=0;o<t.length;o++)r+=n[t[o]%n.length];return r}function O(e){const n=new Uint8Array(e);let t="";for(let r=0;r<n.byteLength;r++)t+=String.fromCharCode(n[r]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function $(e){const t=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",t)}async function x(e){const n=await $(e);return O(n)}function b(e){localStorage.setItem(y,JSON.stringify(e))}function c(){const e=localStorage.getItem(y);return e?JSON.parse(e):null}function A(){localStorage.removeItem(y)}async function R(){const e=w(128),n=await x(e);localStorage.setItem("pkce_verifier",e);const t=w(16);localStorage.setItem("pkce_state",t);const o=`https://accounts.spotify.com/authorize?${new URLSearchParams({client_id:f,response_type:"code",redirect_uri:k,code_challenge_method:"S256",code_challenge:n,state:t,scope:C}).toString()}`;console.log("Redirecting to Spotify authorize URL:",o),window.location.href=o}async function U(){const e=new URLSearchParams(window.location.search),n=e.get("code"),t=e.get("state"),r=localStorage.getItem("pkce_state");if(n){if(history.replaceState({},document.title,window.location.pathname),t!==r)throw new Error("Invalid state from Spotify auth");localStorage.removeItem("pkce_state"),await j(n)}}async function j(e){const n=localStorage.getItem("pkce_verifier"),t=new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:k,client_id:f,code_verifier:n}),r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}),o=await r.json();if(!r.ok)throw new Error(o.error||"Token exchange failed");const s=Date.now()+o.expires_in*1e3;b({access_token:o.access_token,refresh_token:o.refresh_token,expires_at:s}),localStorage.removeItem("pkce_verifier")}async function _(){const e=c();if(!e||!e.refresh_token)throw new Error("No refresh token available");const n=new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refresh_token,client_id:f}),t=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}),r=await t.json();if(!t.ok)throw new Error(r.error||"Refresh failed");const o=Date.now()+r.expires_in*1e3;b({access_token:r.access_token,refresh_token:r.refresh_token||e.refresh_token,expires_at:o})}async function B(){const e=c();return e?(Date.now()>e.expires_at-6e4&&await _(),!0):!1}async function i(e,n={}){if(!await B())throw new Error("Not authenticated");const r=c();n.headers=Object.assign({},n.headers,{Authorization:`Bearer ${r.access_token}`});const o=await fetch(e,n);if(o.status===401){await _();const s=c();return n.headers=Object.assign({},n.headers,{Authorization:`Bearer ${s.access_token}`}),fetch(e,n)}return o}function v(){const e=c();return!!(e&&e.access_token)}function N(){A()}async function F(){const e=await i("https://api.spotify.com/v1/me");if(!e.ok)throw new Error("Failed to fetch profile");return e.json()}async function D(e=50){const n=await i(`https://api.spotify.com/v1/me/playlists?limit=${e}`);if(!n.ok)throw new Error("Failed to fetch playlists");return n.json()}async function H(e,n=100){const t=await i(`https://api.spotify.com/v1/playlists/${e}/tracks?limit=${n}`);if(!t.ok)throw new Error("Failed to fetch playlist tracks");return t.json()}async function M(){const e=await i("https://api.spotify.com/v1/me/player/currently-playing");if(e.status===204)return null;if(!e.ok)throw new Error("Failed to fetch currently playing");return e.json()}async function z(){if(!(await i("https://api.spotify.com/v1/me/player/play",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).ok)throw new Error("Failed to play")}async function J(){if(!(await i("https://api.spotify.com/v1/me/player/pause",{method:"PUT",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to pause")}const h=document.getElementById("login-btn"),S=document.getElementById("displayName"),E=document.getElementById("avatar"),p=document.getElementById("content");function m(){S.textContent="",E.innerHTML="",h.textContent="Login with Spotify",p.innerHTML="<p>Please log in to see your playlists and current track.</p>"}function K(){h.textContent="Logout"}h.addEventListener("click",async()=>{v()?(N(),m()):R()});async function P(){try{const e=await F();S.textContent=e.display_name||e.id,e.images&&e.images.length&&(E.innerHTML=`<img src="${e.images[0].url}" alt="avatar" width="64" />`);const n=await D();let t="<h3>Your Playlists</h3>";t+="<ul>";for(const a of n.items)t+=`<li><button data-id="${a.id}" class="playlist-btn">${a.name} (${a.tracks.total})</button></li>`;t+="</ul>",t+="<h3>Currently Playing</h3>";const r=await M();if(!r)t+="<p>Nothing is currently playing.</p>";else{const a=r.item,d=a.artists.map(u=>u.name).join(", ");t+=`<div><img src="${a.album.images[2]?.url||a.album.images[0].url}" width="64" />`,t+=`<strong>${a.name}</strong> — ${d}`,t+=` <em>on ${a.album.name}</em></div>`}r&&(t+='<div style="margin-top: 0.5rem;">',t+='<button id="play-btn" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">▶ Play</button>',t+='<button id="pause-btn" style="padding: 0.5rem 1rem;">⏸ Pause</button>',t+="</div>"),p.innerHTML=t;const o=document.getElementById("play-btn"),s=document.getElementById("pause-btn");o&&o.addEventListener("click",async()=>{try{await z(),console.log("Playback started")}catch(a){console.error("Play failed:",a)}}),s&&s.addEventListener("click",async()=>{try{await J(),console.log("Playback paused")}catch(a){console.error("Pause failed:",a)}}),document.querySelectorAll(".playlist-btn").forEach(a=>{a.addEventListener("click",async d=>{const u=d.currentTarget.dataset.id,T=await H(u);let l='<button id="back-btn" style="margin-bottom: 1rem; padding: 0.5rem 1rem;">← Back to Playlists</button>';l+="<h4>Tracks</h4><ol>";for(const L of T.items){const g=L.track;l+=`<li>${g.name} — ${g.artists.map(I=>I.name).join(", ")}</li>`}l+="</ol>",p.innerHTML=l,document.getElementById("back-btn").addEventListener("click",P)})}),K()}catch(e){console.error(e),m()}}(async function(){try{await U()}catch(n){console.error("Auth callback error",n)}v()?await P():m()})();

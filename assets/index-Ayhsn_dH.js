(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();const h="1e8524a3ff89495495111505875160d2",_=(window.location.origin+window.location.pathname).replace(/index\.html$/,""),C=["user-read-playback-state","user-read-currently-playing","user-modify-playback-state","playlist-read-private","user-read-private"].join(" "),g="spotify_auth";function v(e=64){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=new Uint8Array(e);crypto.getRandomValues(n);let o="";for(let a=0;a<n.length;a++)o+=t[n[a]%t.length];return o}function x(e){const t=new Uint8Array(e);let n="";for(let o=0;o<t.byteLength;o++)n+=String.fromCharCode(t[o]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function R(e){const n=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",n)}async function U(e){const t=await R(e);return x(t)}function E(e){localStorage.setItem(g,JSON.stringify(e))}function c(){const e=localStorage.getItem(g);return e?JSON.parse(e):null}function j(){localStorage.removeItem(g)}async function B(){const e=v(128),t=await U(e);localStorage.setItem("pkce_verifier",e);const n=v(16);localStorage.setItem("pkce_state",n);const a=`https://accounts.spotify.com/authorize?${new URLSearchParams({client_id:h,response_type:"code",redirect_uri:_,code_challenge_method:"S256",code_challenge:t,state:n,scope:C}).toString()}`;console.log("Redirecting to Spotify authorize URL:",a),window.location.href=a}async function M(){const e=new URLSearchParams(window.location.search),t=e.get("code"),n=e.get("state"),o=localStorage.getItem("pkce_state");if(t){if(history.replaceState({},document.title,window.location.pathname),n!==o)throw new Error("Invalid state from Spotify auth");localStorage.removeItem("pkce_state"),await F(t)}}async function F(e){const t=localStorage.getItem("pkce_verifier"),n=new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:_,client_id:h,code_verifier:t}),o=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}),a=await o.json();if(!o.ok)throw new Error(a.error||"Token exchange failed");const r=Date.now()+a.expires_in*1e3;E({access_token:a.access_token,refresh_token:a.refresh_token,expires_at:r}),localStorage.removeItem("pkce_verifier")}async function P(){const e=c();if(!e||!e.refresh_token)throw new Error("No refresh token available");const t=new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refresh_token,client_id:h}),n=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}),o=await n.json();if(!n.ok)throw new Error(o.error||"Refresh failed");const a=Date.now()+o.expires_in*1e3;E({access_token:o.access_token,refresh_token:o.refresh_token||e.refresh_token,expires_at:a})}async function H(){const e=c();return e?(Date.now()>e.expires_at-6e4&&await P(),!0):!1}async function s(e,t={}){if(!await H())throw new Error("Not authenticated");const o=c();t.headers=Object.assign({},t.headers,{Authorization:`Bearer ${o.access_token}`});const a=await fetch(e,t);if(a.status===401){await P();const r=c();return t.headers=Object.assign({},t.headers,{Authorization:`Bearer ${r.access_token}`}),fetch(e,t)}return a}function u(){const e=c();return!!(e&&e.access_token)}function D(){j()}async function z(){const e=await s("https://api.spotify.com/v1/me");if(!e.ok)throw new Error("Failed to fetch profile");return e.json()}async function G(e=50){const t=await s(`https://api.spotify.com/v1/me/playlists?limit=${e}`);if(!t.ok)throw new Error("Failed to fetch playlists");return t.json()}async function J(e,t=100){const n=await s(`https://api.spotify.com/v1/playlists/${e}/tracks?limit=${t}`);if(!n.ok)throw new Error("Failed to fetch playlist tracks");return n.json()}async function T(){const e=await s("https://api.spotify.com/v1/me/player/currently-playing");if(e.status===204)return null;if(!e.ok)throw new Error("Failed to fetch currently playing");return e.json()}async function K(){if(!(await s("https://api.spotify.com/v1/me/player/play",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).ok)throw new Error("Failed to play")}async function V(){if(!(await s("https://api.spotify.com/v1/me/player/pause",{method:"PUT",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to pause")}const w=document.getElementById("login-btn"),S=document.getElementById("displayName"),I=document.getElementById("avatar"),p=document.getElementById("content"),L=1e4;let d=null;async function y(){try{const e=await T();let t=document.getElementById("now-playing");if(t||(t=document.createElement("div"),t.id="now-playing",p.prepend(t)),!e){t.innerHTML="<p>Nothing is currently playing.</p>";return}const n=e.item,o=(n.artists||[]).map(r=>r.name).join(", "),a=n.album?.images?.[2]?.url||n.album?.images?.[0]?.url||"";t.innerHTML=`
      <div style="display:flex;align-items:center;gap:.5rem">
        ${a?`<img src="${a}" width="64" alt="album art">`:""}
        <div>
          <div><strong>${n.name}</strong></div>
          <div style="font-size:.9rem;color:#666">${o} — <em>${n.album?.name||""}</em></div>
        </div>
      </div>
    `}catch(e){console.error("updateNowPlaying error",e)}}function Y(e=L){q();let t=e;y(),d=setInterval(()=>{u()&&!document.hidden&&y()},t),document.addEventListener("visibilitychange",()=>{document.hidden||u()&&y()},{once:!1})}function q(){d&&(clearInterval(d),d=null)}function k(){S.textContent="",I.innerHTML="",w.textContent="Login with Spotify",p.innerHTML="<p>Please log in to see your playlists and current track.</p>"}function W(){w.textContent="Logout"}w.addEventListener("click",async()=>{u()?(D(),k()):B()});async function $(){try{const e=await z();S.textContent=e.display_name||e.id,e.images&&e.images.length&&(I.innerHTML=`<img src="${e.images[0].url}" alt="avatar" width="64" />`);const t=await G();let n="<h3>Your Playlists</h3>";n+="<ul>";for(const i of t.items)n+=`<li><button data-id="${i.id}" class="playlist-btn">${i.name} (${i.tracks.total})</button></li>`;n+="</ul>",n+="<h3>Currently Playing</h3>";const o=await T();if(!o)n+="<p>Nothing is currently playing.</p>";else{const i=o.item,f=i.artists.map(m=>m.name).join(", ");n+=`<div><img src="${i.album.images[2]?.url||i.album.images[0].url}" width="64" />`,n+=`<strong>${i.name}</strong> — ${f}`,n+=` <em>on ${i.album.name}</em></div>`}o&&(n+='<div style="margin-top: 0.5rem;">',n+='<button id="play-btn" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">▶ Play</button>',n+='<button id="pause-btn" style="padding: 0.5rem 1rem;">⏸ Pause</button>',n+="</div>"),p.innerHTML=n;const a=document.getElementById("play-btn"),r=document.getElementById("pause-btn");a&&a.addEventListener("click",async()=>{try{await K(),console.log("Playback started")}catch(i){console.error("Play failed:",i)}}),r&&r.addEventListener("click",async()=>{try{await V(),console.log("Playback paused")}catch(i){console.error("Pause failed:",i)}}),document.querySelectorAll(".playlist-btn").forEach(i=>{i.addEventListener("click",async f=>{const m=f.currentTarget.dataset.id,N=await J(m);let l='<button id="back-btn" style="margin-bottom: 1rem; padding: 0.5rem 1rem;">← Back to Playlists</button>';l+="<h4>Tracks</h4><ol>";for(const O of N.items){const b=O.track;l+=`<li>${b.name} — ${b.artists.map(A=>A.name).join(", ")}</li>`}l+="</ol>",p.innerHTML=l,document.getElementById("back-btn").addEventListener("click",$)})}),W(),Y(L)}catch(e){console.error(e),k()}}(async function(){try{await M()}catch(t){console.error("Auth callback error",t)}u()?await $():k()})();

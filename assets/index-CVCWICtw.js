(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const h="1e8524a3ff89495495111505875160d2",v=(window.location.origin+window.location.pathname).replace(/index\.html$/,""),x=["user-read-playback-state","user-read-currently-playing","user-modify-playback-state","playlist-read-private","user-read-private"].join(" "),g="spotify_auth";function b(e=64){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=new Uint8Array(e);crypto.getRandomValues(o);let r="";for(let n=0;n<o.length;n++)r+=t[o[n]%t.length];return r}function O(e){const t=new Uint8Array(e);let o="";for(let r=0;r<t.byteLength;r++)o+=String.fromCharCode(t[r]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function N(e){const o=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",o)}async function A(e){const t=await N(e);return O(t)}function _(e){localStorage.setItem(g,JSON.stringify(e))}function u(){const e=localStorage.getItem(g);return e?JSON.parse(e):null}function C(){localStorage.removeItem(g)}async function $(){const e=b(128),t=await A(e);localStorage.setItem("pkce_verifier",e);const o=b(16);localStorage.setItem("pkce_state",o);const n=`https://accounts.spotify.com/authorize?${new URLSearchParams({client_id:h,response_type:"code",redirect_uri:v,code_challenge_method:"S256",code_challenge:t,state:o,scope:x}).toString()}`;console.log("Redirecting to Spotify authorize URL:",n),window.location.href=n}async function R(){const e=new URLSearchParams(window.location.search),t=e.get("code"),o=e.get("state"),r=localStorage.getItem("pkce_state");if(t){if(history.replaceState({},document.title,window.location.pathname),o!==r)throw new Error("Invalid state from Spotify auth");localStorage.removeItem("pkce_state"),await U(t)}}async function U(e){const t=localStorage.getItem("pkce_verifier"),o=new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:v,client_id:h,code_verifier:t}),r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()}),n=await r.json();if(!r.ok)throw new Error(n.error||"Token exchange failed");const a=Date.now()+n.expires_in*1e3;_({access_token:n.access_token,refresh_token:n.refresh_token,expires_at:a}),localStorage.removeItem("pkce_verifier")}async function P(){const e=u();if(!e||!e.refresh_token)throw new Error("No refresh token available");const t=new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refresh_token,client_id:h}),o=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}),r=await o.json();if(!o.ok)throw new Error(r.error||"Refresh failed");const n=Date.now()+r.expires_in*1e3;_({access_token:r.access_token,refresh_token:r.refresh_token||e.refresh_token,expires_at:n})}async function B(){const e=u();return e?(Date.now()>e.expires_at-6e4&&await P(),!0):!1}async function l(e,t={}){if(!await B())throw new Error("Not authenticated");const r=u();t.headers=Object.assign({},t.headers,{Authorization:`Bearer ${r.access_token}`});const n=await fetch(e,t);if(n.status===401){await P();const a=u();return t.headers=Object.assign({},t.headers,{Authorization:`Bearer ${a.access_token}`}),fetch(e,t)}return n}function f(){const e=u();return!!(e&&e.access_token)}function j(){C()}async function F(){const e=await l("https://api.spotify.com/v1/me");if(!e.ok)throw new Error("Failed to fetch profile");return e.json()}async function M(e=50){const t=await l(`https://api.spotify.com/v1/me/playlists?limit=${e}`);if(!t.ok)throw new Error("Failed to fetch playlists");return t.json()}async function H(e,t=100){const o=await l(`https://api.spotify.com/v1/playlists/${e}/tracks?limit=${t}`);if(!o.ok)throw new Error("Failed to fetch playlist tracks");return o.json()}async function D(){const e=await l("https://api.spotify.com/v1/me/player/currently-playing");if(e.status===204)return null;if(!e.ok)throw new Error("Failed to fetch currently playing");return e.json()}async function q(){if(!(await l("https://api.spotify.com/v1/me/player/play",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).ok)throw new Error("Failed to play")}async function z(){if(!(await l("https://api.spotify.com/v1/me/player/pause",{method:"PUT",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to pause")}async function G(){if(!(await l("https://api.spotify.com/v1/me/player/next",{method:"POST"})).ok)throw new Error("Failed to skip to next track")}async function J(){if(!(await l("https://api.spotify.com/v1/me/player/previous",{method:"POST"})).ok)throw new Error("Failed to skip to previous track")}const w=document.getElementById("login-btn"),S=document.getElementById("displayName"),T=document.getElementById("avatar"),m=document.getElementById("content"),E=1e4;let y=null;async function c(){try{const e=await D();let t=document.getElementById("now-playing");if(t||(t=document.createElement("div"),t.id="now-playing",m.append(t)),!e){t.innerHTML="<p>Nothing is currently playing.</p>";return}const o=e.item,r=(o.artists||[]).map(i=>i.name).join(", "),n=o.album?.images?.[2]?.url||o.album?.images?.[0]?.url||"";t.innerHTML=`
			<div style="display:flex;align-items:center;gap:.5rem">
				${n?`<img src="${n}" width="64" alt="album art">`:""}
				<div>
					<div><strong>${o.name}</strong></div>
					<div style="font-size:.9rem;color:#666">${r} — <em>${o.album?.name||""}</em></div>
				</div>
			</div>
			<div style="margin-top: 0.5rem;">
				<button id="prev-btn" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">⏮ Prev</button>
				<button id="play-btn" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">▶ Play</button>
				<button id="pause-btn" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">⏸ Pause</button>
				<button id="next-btn" style="padding: 0.5rem 1rem;">⏭ Next</button>
			</div>
		`;const a=t.querySelector("#play-btn"),s=t.querySelector("#pause-btn"),d=t.querySelector("#next-btn"),p=t.querySelector("#prev-btn");a&&(a.onclick=async()=>{try{await q(),console.log("Playback started"),await c()}catch(i){console.error("Play failed:",i)}}),s&&(s.onclick=async()=>{try{await z(),console.log("Playback paused"),await c()}catch(i){console.error("Pause failed:",i)}}),d&&(d.onclick=async()=>{try{await G(),console.log("Skipped to next"),setTimeout(c,600)}catch(i){console.error("Next failed:",i)}}),p&&(p.onclick=async()=>{try{await J(),console.log("Skipped to previous"),setTimeout(c,600)}catch(i){console.error("Previous failed:",i)}})}catch(e){console.error("updateNowPlaying error",e)}}function K(e=E){V();let t=e;c(),y=setInterval(()=>{f()&&!document.hidden&&c()},t),document.addEventListener("visibilitychange",()=>{document.hidden||f()&&c()},{once:!1})}function V(){y&&(clearInterval(y),y=null)}function k(){S.textContent="",T.innerHTML="",w.textContent="Login with Spotify",m.innerHTML="<p>Please log in to see your playlists and current track.</p>"}function Y(){w.textContent="Logout"}w.addEventListener("click",async()=>{f()?(j(),k()):$()});async function I(){try{const e=await F();S.textContent=e.display_name||e.id,e.images&&e.images.length&&(T.innerHTML=`<img src="${e.images[0].url}" alt="avatar" width="64" />`);const t=await M();let o="<h3>Your Playlists</h3>";o+="<ul>";for(const r of t.items)o+=`<li><button data-id="${r.id}" class="playlist-btn">${r.name} (${r.tracks.total})</button></li>`;o+="</ul>",o+="<h3>Currently Playing</h3>",m.innerHTML=o,await c(),document.querySelectorAll(".playlist-btn").forEach(r=>{r.addEventListener("click",async n=>{const a=n.currentTarget.dataset.id,s=await H(a);let d='<button id="back-btn" style="margin-bottom: 1rem; padding: 0.5rem 1rem;">← Back to Playlists</button>';d+="<h4>Tracks</h4><ol>";for(const p of s.items){const i=p.track;d+=`<li>${i.name} — ${i.artists.map(L=>L.name).join(", ")}</li>`}d+="</ol>",m.innerHTML=d,document.getElementById("back-btn").addEventListener("click",I)})}),Y(),K(E)}catch(e){console.error(e),k()}}(async function(){try{await R()}catch(t){console.error("Auth callback error",t)}f()?await I():k()})();

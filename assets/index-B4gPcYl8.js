(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(t){if(t.ep)return;t.ep=!0;const a=o(t);fetch(t.href,a)}})();const d="1e8524a3ff89495495111505875160d2",g=(window.location.origin+window.location.pathname).replace(/index\.html$/,""),I=["user-read-playback-state","user-read-currently-playing","playlist-read-private","user-read-private"].join(" "),f="spotify_auth";function y(e=64){const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=new Uint8Array(e);crypto.getRandomValues(o);let r="";for(let t=0;t<o.length;t++)r+=n[o[t]%n.length];return r}function P(e){const n=new Uint8Array(e);let o="";for(let r=0;r<n.byteLength;r++)o+=String.fromCharCode(n[r]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function C(e){const o=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",o)}async function $(e){const n=await C(e);return P(n)}function w(e){localStorage.setItem(f,JSON.stringify(e))}function c(){const e=localStorage.getItem(f);return e?JSON.parse(e):null}function O(){localStorage.removeItem(f)}async function x(){const e=y(128),n=await $(e);localStorage.setItem("pkce_verifier",e);const o=y(16);localStorage.setItem("pkce_state",o);const t=`https://accounts.spotify.com/authorize?${new URLSearchParams({client_id:d,response_type:"code",redirect_uri:g,code_challenge_method:"S256",code_challenge:n,state:o,scope:I}).toString()}`;console.log("Redirecting to Spotify authorize URL:",t),window.location.href=t}async function A(){const e=new URLSearchParams(window.location.search),n=e.get("code"),o=e.get("state"),r=localStorage.getItem("pkce_state");if(n){if(history.replaceState({},document.title,window.location.pathname),o!==r)throw new Error("Invalid state from Spotify auth");localStorage.removeItem("pkce_state"),await R(n)}}async function R(e){const n=localStorage.getItem("pkce_verifier"),o=new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:g,client_id:d,code_verifier:n}),r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()}),t=await r.json();if(!r.ok)throw new Error(t.error||"Token exchange failed");const a=Date.now()+t.expires_in*1e3;w({access_token:t.access_token,refresh_token:t.refresh_token,expires_at:a}),localStorage.removeItem("pkce_verifier")}async function k(){const e=c();if(!e||!e.refresh_token)throw new Error("No refresh token available");const n=new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refresh_token,client_id:d}),o=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()}),r=await o.json();if(!o.ok)throw new Error(r.error||"Refresh failed");const t=Date.now()+r.expires_in*1e3;w({access_token:r.access_token,refresh_token:r.refresh_token||e.refresh_token,expires_at:t})}async function U(){const e=c();return e?(Date.now()>e.expires_at-6e4&&await k(),!0):!1}async function l(e,n={}){if(!await U())throw new Error("Not authenticated");const r=c();n.headers=Object.assign({},n.headers,{Authorization:`Bearer ${r.access_token}`});const t=await fetch(e,n);if(t.status===401){await k();const a=c();return n.headers=Object.assign({},n.headers,{Authorization:`Bearer ${a.access_token}`}),fetch(e,n)}return t}function _(){const e=c();return!!(e&&e.access_token)}function N(){O()}async function j(){const e=await l("https://api.spotify.com/v1/me");if(!e.ok)throw new Error("Failed to fetch profile");return e.json()}async function B(e=50){const n=await l(`https://api.spotify.com/v1/me/playlists?limit=${e}`);if(!n.ok)throw new Error("Failed to fetch playlists");return n.json()}async function D(e,n=100){const o=await l(`https://api.spotify.com/v1/playlists/${e}/tracks?limit=${n}`);if(!o.ok)throw new Error("Failed to fetch playlist tracks");return o.json()}async function F(){const e=await l("https://api.spotify.com/v1/me/player/currently-playing");if(e.status===204)return null;if(!e.ok)throw new Error("Failed to fetch currently playing");return e.json()}const h=document.getElementById("login-btn"),b=document.getElementById("displayName"),S=document.getElementById("avatar"),u=document.getElementById("content");function p(){b.textContent="",S.innerHTML="",h.textContent="Login with Spotify",u.innerHTML="<p>Please log in to see your playlists and current track.</p>"}function H(){h.textContent="Logout"}h.addEventListener("click",async()=>{_()?(N(),p()):x()});async function v(){try{const e=await j();b.textContent=e.display_name||e.id,e.images&&e.images.length&&(S.innerHTML=`<img src="${e.images[0].url}" alt="avatar" width="64" />`);const n=await B();let o="<h3>Your Playlists</h3>";o+="<ul>";for(const t of n.items)o+=`<li><button data-id="${t.id}" class="playlist-btn">${t.name} (${t.tracks.total})</button></li>`;o+="</ul>",o+="<h3>Currently Playing</h3>";const r=await F();if(!r)o+="<p>Nothing is currently playing.</p>";else{const t=r.item,a=t.artists.map(s=>s.name).join(", ");o+=`<div><img src="${t.album.images[2]?.url||t.album.images[0].url}" width="64" />`,o+=`<strong>${t.name}</strong> — ${a}`,o+=` <em>on ${t.album.name}</em></div>`}u.innerHTML=o,document.querySelectorAll(".playlist-btn").forEach(t=>{t.addEventListener("click",async a=>{const s=a.currentTarget.dataset.id,E=await D(s);let i='<button id="back-btn" style="margin-bottom: 1rem; padding: 0.5rem 1rem;">← Back to Playlists</button>';i+="<h4>Tracks</h4><ol>";for(const T of E.items){const m=T.track;i+=`<li>${m.name} — ${m.artists.map(L=>L.name).join(", ")}</li>`}i+="</ol>",u.innerHTML=i,document.getElementById("back-btn").addEventListener("click",v)})}),H()}catch(e){console.error(e),p()}}(async function(){try{await A()}catch(n){console.error("Auth callback error",n)}_()?await v():p()})();

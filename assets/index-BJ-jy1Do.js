(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();const y="1e8524a3ff89495495111505875160d2",b=(window.location.origin+window.location.pathname).replace(/index\.html$/,""),O=["user-read-playback-state","user-read-currently-playing","user-modify-playback-state","playlist-read-private","user-read-private"].join(" "),h="spotify_auth";function k(e=64){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=new Uint8Array(e);crypto.getRandomValues(o);let a="";for(let n=0;n<o.length;n++)a+=t[o[n]%t.length];return a}function A(e){const t=new Uint8Array(e);let o="";for(let a=0;a<t.byteLength;a++)o+=String.fromCharCode(t[a]);return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function C(e){const o=new TextEncoder().encode(e);return await crypto.subtle.digest("SHA-256",o)}async function N(e){const t=await C(e);return A(t)}function _(e){localStorage.setItem(h,JSON.stringify(e))}function d(){const e=localStorage.getItem(h);return e?JSON.parse(e):null}function $(){localStorage.removeItem(h)}async function x(){const e=k(128),t=await N(e);localStorage.setItem("pkce_verifier",e);const o=k(16);localStorage.setItem("pkce_state",o);const n=`https://accounts.spotify.com/authorize?${new URLSearchParams({client_id:y,response_type:"code",redirect_uri:b,code_challenge_method:"S256",code_challenge:t,state:o,scope:O}).toString()}`;console.log("Redirecting to Spotify authorize URL:",n),window.location.href=n}async function R(){const e=new URLSearchParams(window.location.search),t=e.get("code"),o=e.get("state"),a=localStorage.getItem("pkce_state");if(t){if(history.replaceState({},document.title,window.location.pathname),o!==a)throw new Error("Invalid state from Spotify auth");localStorage.removeItem("pkce_state"),await U(t)}}async function U(e){const t=localStorage.getItem("pkce_verifier"),o=new URLSearchParams({grant_type:"authorization_code",code:e,redirect_uri:b,client_id:y,code_verifier:t}),a=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString()}),n=await a.json();if(!a.ok)throw new Error(n.error||"Token exchange failed");const r=Date.now()+n.expires_in*1e3;_({access_token:n.access_token,refresh_token:n.refresh_token,expires_at:r}),localStorage.removeItem("pkce_verifier")}async function v(){const e=d();if(!e||!e.refresh_token)throw new Error("No refresh token available");const t=new URLSearchParams({grant_type:"refresh_token",refresh_token:e.refresh_token,client_id:y}),o=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t.toString()}),a=await o.json();if(!o.ok)throw new Error(a.error||"Refresh failed");const n=Date.now()+a.expires_in*1e3;_({access_token:a.access_token,refresh_token:a.refresh_token||e.refresh_token,expires_at:n})}async function j(){const e=d();return e?(Date.now()>e.expires_at-6e4&&await v(),!0):!1}async function l(e,t={}){if(!await j())throw new Error("Not authenticated");const a=d();t.headers=Object.assign({},t.headers,{Authorization:`Bearer ${a.access_token}`});const n=await fetch(e,t);if(n.status===401){await v();const r=d();return t.headers=Object.assign({},t.headers,{Authorization:`Bearer ${r.access_token}`}),fetch(e,t)}return n}function p(){const e=d();return!!(e&&e.access_token)}function B(){$()}async function M(){const e=await l("https://api.spotify.com/v1/me");if(!e.ok)throw new Error("Failed to fetch profile");return e.json()}async function F(e=50){const t=await l(`https://api.spotify.com/v1/me/playlists?limit=${e}`);if(!t.ok)throw new Error("Failed to fetch playlists");return t.json()}async function H(e,t=100){const o=await l(`https://api.spotify.com/v1/playlists/${e}/tracks?limit=${t}`);if(!o.ok)throw new Error("Failed to fetch playlist tracks");return o.json()}async function D(){const e=await l("https://api.spotify.com/v1/me/player/currently-playing");if(e.status===204)return null;if(!e.ok)throw new Error("Failed to fetch currently playing");return e.json()}async function z(){if(!(await l("https://api.spotify.com/v1/me/player/play",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})).ok)throw new Error("Failed to play")}async function q(){if(!(await l("https://api.spotify.com/v1/me/player/pause",{method:"PUT",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to pause")}const m=document.getElementById("login-btn"),P=document.getElementById("displayName"),S=document.getElementById("avatar"),f=document.getElementById("content"),T=1e4;let u=null;async function c(){try{const e=await D();let t=document.getElementById("now-playing");if(t||(t=document.createElement("div"),t.id="now-playing",f.append(t)),!e){t.innerHTML="<p>Nothing is currently playing.</p>";return}const o=e.item,a=(o.artists||[]).map(i=>i.name).join(", "),n=o.album?.images?.[2]?.url||o.album?.images?.[0]?.url||"";t.innerHTML=`
			<div style="display:flex;align-items:center;gap:.5rem">
				${n?`<img src="${n}" width="64" alt="album art">`:""}
				<div>
					<div><strong>${o.name}</strong></div>
					<div style="font-size:.9rem;color:#666">${a} — <em>${o.album?.name||""}</em></div>
				</div>
			</div>
			<div style="margin-top: 0.5rem;">
				<button id="play-btn" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">▶ Play</button>
				<button id="pause-btn" style="padding: 0.5rem 1rem;">⏸ Pause</button>
			</div>
		`;const r=t.querySelector("#play-btn"),s=t.querySelector("#pause-btn");r&&(r.onclick=async()=>{try{await z(),console.log("Playback started"),await c()}catch(i){console.error("Play failed:",i)}}),s&&(s.onclick=async()=>{try{await q(),console.log("Playback paused"),await c()}catch(i){console.error("Pause failed:",i)}})}catch(e){console.error("updateNowPlaying error",e)}}function G(e=T){J();let t=e;c(),u=setInterval(()=>{p()&&!document.hidden&&c()},t),document.addEventListener("visibilitychange",()=>{document.hidden||p()&&c()},{once:!1})}function J(){u&&(clearInterval(u),u=null)}function g(){P.textContent="",S.innerHTML="",m.textContent="Login with Spotify",f.innerHTML="<p>Please log in to see your playlists and current track.</p>"}function K(){m.textContent="Logout"}m.addEventListener("click",async()=>{p()?(B(),g()):x()});async function E(){try{const e=await M();P.textContent=e.display_name||e.id,e.images&&e.images.length&&(S.innerHTML=`<img src="${e.images[0].url}" alt="avatar" width="64" />`);const t=await F();let o="<h3>Your Playlists</h3>";o+="<ul>";for(const a of t.items)o+=`<li><button data-id="${a.id}" class="playlist-btn">${a.name} (${a.tracks.total})</button></li>`;o+="</ul>",o+="<h3>Currently Playing</h3>",f.innerHTML=o,await c(),document.querySelectorAll(".playlist-btn").forEach(a=>{a.addEventListener("click",async n=>{const r=n.currentTarget.dataset.id,s=await H(r);let i='<button id="back-btn" style="margin-bottom: 1rem; padding: 0.5rem 1rem;">← Back to Playlists</button>';i+="<h4>Tracks</h4><ol>";for(const I of s.items){const w=I.track;i+=`<li>${w.name} — ${w.artists.map(L=>L.name).join(", ")}</li>`}i+="</ol>",f.innerHTML=i,document.getElementById("back-btn").addEventListener("click",E)})}),K(),G(T)}catch(e){console.error(e),g()}}(async function(){try{await R()}catch(t){console.error("Auth callback error",t)}p()?await E():g()})();
